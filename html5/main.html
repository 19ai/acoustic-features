<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Inference visualization</title>

  <link href="css/css.css" rel="stylesheet" type="text/css">

  <!-- Vue.js and paho-mqtt -->
  <script src="https://jp.vuejs.org/js/vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

  <!-- Local libraries -->
  <script src="./lib/uuid.js"></script>
  <script src="./lib/rest.js"></script>

  <!-- Edge AI class definition -->
  <script src="./use_cases/class_labels_my_home.js"></script>
</head>

<body>

  <div id="app">

    <div id="title">{{title}}</div>

    <br>

    <!-- Current/past selection widget -->
    <div class="widget">
      <form id="select" onchange="onButtonChecked()">
        <input type="radio" name="operation" value="current" checked="checked"> Current log<br>
        <input type="radio" name="operation" value="past"> Past log<br>
      </form>
    </div>

    <br>

    <!-- Parameters widget -->
    <div class="widget">
      Device name: 
      <select id="devices" v-model="device_name">
        <option disabled value="">Please select one</option>
      </select>
      <br>

      <div id="current">
        Time stamp: {{timestamp}}<br>
        Inference: [#{{sno}}] {{message}}
      </div>
      <div id="past">
        <form onsubmit="return onDateTimeEntered()">
          From:
          <input type="datetime-local" name="from">
          To:
          <input type="datetime-local" name="to">
          <br>
          <input type="submit" value="Show">
        </form>
      </div>

    </div>

  </div>

  <br>

  <!-- Log widget (line chart)  -->
  <div class="widget">
    <canvas id="Log"></canvas>
  </div>

  <script>
    get('/devices', devices => {
      let select = document.getElementById("devices");
      devices.forEach(it => {
        select.options[select.options.length] = new Option(it);
      });
    });
  </script>

  <script>
    // MQTT topic
    const TOPIC = 'sensor';

    // Class labels
    const numClasses = Object.keys(classLabels).length
    const classLabelsName = Object.values(classLabels).reverse();

    // Chirt
    const NUM_RECORDS = 20;
    const INTERVAL = 10; 
  </script>

  <script>
    // Vue app object
    let app = new Vue({
    	el: '#app',
      data: {
        title: useCase,
      	device_name: '',
        timestamp: '',
        message: '',
        sno: 0
      }
    });
  </script>

  <script>
    // Create Chart object
    let ctx = document.getElementById('Log').getContext('2d');
    let chart = new Chart(ctx, {
      type: 'line',

      data: {
        labels: [],
        datasets: [{
          borderColor: 'rgb(255, 99, 132)',
          data: [],
          fill: false,
          pointStyle: 'rect',
          steppedLine: 'after'
        }]
      },

      options: {
        legend: {
          display: false,
        },
        title: {
          display: true,
          text: 'Acoustic Scene Classification',
          fontSize: 20
        },
        scales: {
          yAxes: [{
            ticks: {
              callback: function(value, index, values) {
                return classLabelsName[index] + '(' + value + ')';
              },
              min: 0,
              max: numClasses - 1,
              stepSize: 1
            }
          }]
        }
      }
    });

    // Connected to MQTT server
    function onConnect() {
      console.log('Connected to MQTT server');
      mqtt.subscribe(TOPIC);
    }

    function mostFrequent(buf) {
      let win = -1;
      // Frequency of appearance
      Object.keys(buf).forEach(key => {
        if (win == -1) {
          win = key;
        } else if (buf[key] > buf[win]) {
          win = key;
        }
      });
      //console.log(buf);
      return win;
    } 

    // MQTT message serial number
    let sno = 0;

    // FIFO buffer for logging 
    let reached = false;

    // Buffer for taking an frequency of appearance 
    let buf = {};

    // MQTT message
    function onMessageArrived(msg) {

      let data = msg.payloadString;
      //console.log(data);
      data = data.split(',')
      let device_name = data[0];
      if (device_name == app.device_name) { 

        let epoch_time = parseFloat(data[1]) * 1000;  // milliseconds
        let date_time = new Date(epoch_time);
        app.timestamp = date_time;
        let classLabel = data[2];
        let classLabelInt = parseInt(classLabel);
        let name = classLabels[classLabelInt];
        app.message = name + "(" + classLabel + ")";
        sno = sno + 1;
        app.sno = sno;

        // Buffering
        if (classLabelInt in buf) {
          buf[classLabelInt]++;
        } else {
          buf[classLabelInt] = 1;
        }

        if ((sno % INTERVAL) == 0) {
          let win = mostFrequent(buf);
          buf = {};

          // Put in FIFO buffer and update Chart 
          chart.data.datasets[0].data.push(win);
          chart.data.labels.push(date_time.toLocaleTimeString());
          if (!reached && chart.data.datasets[0].data.length > NUM_RECORDS) {
            reached = true;
          }
          else if (reached) {
            chart.data.datasets[0].data.shift();
            chart.data.labels.shift();
          }
          chart.update();
        }

      }
    }

    // Connection to MQTT server
    function connect() {
      const host = window.location.hostname
      const port = 11883  // MQTT over WebSocket
    	mqtt = new Paho.MQTT.Client(host, port, uuidv4());

      let options = {
      	timeout: 3,
        onSuccess: onConnect,
      };
      mqtt.onMessageArrived = onMessageArrived
      mqtt.connect(options);
      console.log('Connecting to MQTT server: ' + host)
    }

  </script>

  <!-- Form events handling -->
  <script>
    function onButtonChecked() {
      let form = document.getElementById("select");
      let current = document.getElementById("current");
      let past = document.getElementById("past");
      if (form.operation.value == "current") {
        mqtt.subscribe(TOPIC);
        current.style.display = "block";
        past.style.display = "none";
        chart.data.datasets[0].data = [];
        chart.data.labels = [];
        chart.update();
      } else if (form.operation.value == "past") {
        mqtt.unsubscribe(TOPIC);
        current.style.display = "none";
        past.style.display = "block";
        // Set default datetime
        let tzoffset = (new Date()).getTimezoneOffset() * 60000;
        let now = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 16);
        document.querySelector('input[name="from"]').value = now;
        document.querySelector('input[name="to"]').value = now;
      }
    }

    function onDateTimeEntered() {
      let from = document.querySelector('input[name="from"]');
      let to = document.querySelector('input[name="to"]');
      from = new Date(from.value).getTime()/1000.0;  // Epoch time in seconds
      to = new Date(to.value).getTime()/1000.0;  // Epoch time in seconds

      get('/log/' + app.device_name + queryParams({from: from, to: to}), doc => {
        //console.log(doc);
        // Update chart
        let data = [];
        let labels = [];
        let localeTime;
        let cnt = 0;
        let buf = {};
        doc.forEach(it => {
          let classLabelInt = parseInt(it.data); 
          if (classLabelInt in buf) {
            buf[classLabelInt]++;
          } else {
            buf[classLabelInt] = 1;
          }
          if ((++cnt % INTERVAL) == 0) { 
            let win = mostFrequent(buf);
            data.push(win);
            localeTime = parseFloat(it.timestamp) * 1000;
            localeTime = new Date(localeTime).toLocaleTimeString();
            labels.push(localeTime);
            buf = {};
          }
        })
        //console.log(data, labels);
        chart.data.datasets[0].data = data;
        chart.data.labels = labels;
        chart.update();
      });

      return false;
    }

  </script>

  <script>
    // Connect to MQTT server over WebSocket
    connect();
  </script>

</body>

</html>
