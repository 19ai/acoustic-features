<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Inference visualization</title>

  <!-- Vue.js and paho-mqtt -->
  <script src="https://jp.vuejs.org/js/vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

  <!-- Local libraries -->
  <script src="./uuid.js"></script>
  <script src="./class_labels.js"></script>
</head>

<body>

  <h2>Acoustic Scene Classification</h2>

  <p>Current inference result</p>

	<div id="app">
 		Device Name: {{device_name}}<br>
    Time stamp: {{timestamp}}<br>
    Class label: [#{{sno}}] {{message}}
  </div>

  <canvas id="Log"></canvas>

  <script>
    // Chirt 
    const NUM_RECORDS = 20;
    const INTERVAL = 10; 

    // MQTT
    const host = window.location.hostname
    console.log(host)
    const port = 11883  // MQTT over WebSocket
    const topic = 'sensor'
  </script>

  <script>
    // Vue app object
    let app = new Vue({
    	el: '#app',
      data: {
      	device_name: '',
        timestamp: '',
        message: '',
        sno: 0
      }
    });
  </script>


  <script>
    // MQTT message serial number
    let sno = 0;

    // FIFO buffer for logging 
    let reached = false;

    // Buffer for taking an frequency of appearance 
    let buf = {};

    // Class labels
    const numClasses = Object.keys(class_labels).length
    const class_labels_name = Object.values(class_labels).reverse();

    // Create Chart object
		let ctx = document.getElementById('Log').getContext('2d');
    let chart = new Chart(ctx, {
      type: 'line',

      data: {
        labels: [],
        datasets: [{
          borderColor: 'rgb(255, 99, 132)',
          data: [],
          fill: false,
          pointStyle: 'rect',
          steppedLine: 'after'
        }]
      },

      options: {
        legend: {
          display: false,
        },
        title: {
          display: true,
          text: 'Acoustic Scene Classification',
          fontSize: 20
        },
        scales: {
          yAxes: [{
            ticks: {
              callback: function(value, index, values) {
                return class_labels_name[index] + '(' + value + ')';
              },
              min: 0,
              max: numClasses - 1,
              stepSize: 1
            }
          }]
        }
      }
    });

    // Connected to MQTT server
    function onConnect() {
    	console.log('connected');
      mqtt.subscribe(topic);
    }

    // MQTT message
    function onMessageArrived(msg) {

      let win = -1;

      let data = msg.payloadString;
      console.log(data);
      data = data.split(',')
      app.device_name = data[0];
      let epoch_time = parseFloat(data[1]) * 1000;  // milliseconds
      let date_time = new Date(epoch_time);
      app.timestamp = date_time;
      let class_label = data[2];
      let class_label_int = parseInt(class_label);
      let name = to_name(class_label_int);
      app.message = name + "(" + class_label + ")";
      sno = sno + 1;
      app.sno = sno;

      // Buffering
      if (class_label_int in buf) {
        buf[class_label_int]++;
      } else {
        buf[class_label_int] = 1;
      }

      if ((sno % INTERVAL) == 0) {
        win = -1;
        // Frequency of appearance
        Object.keys(buf).forEach(key => {
          if (win == -1) {
            win = key;
          } else if (buf[key] > buf[win]) {
            win = key;
          }
        }); 

        // Put in FIFO buffer and update Chart 
        chart.data.datasets[0].data.push(win);
        chart.data.labels.push(date_time.toLocaleTimeString());
        if (!reached && chart.data.datasets[0].data.length > NUM_RECORDS) {
          reached = true;
        }
        else if (reached) {
          chart.data.datasets[0].data.shift();
          chart.data.labels.shift();
        }
        chart.update();
      }
    }

    // Connection to MQTT server
    function connect() {
    	mqtt = new Paho.MQTT.Client(host, port, uuidv4());
      let options = {
      	timeout: 3,
        onSuccess: onConnect,
      };
      mqtt.onMessageArrived = onMessageArrived
      mqtt.connect(options);
      console.log('connecting...');
    }

    // Connect to MQTT server over WebSocket
    connect();
  </script>

</body>

</html>
